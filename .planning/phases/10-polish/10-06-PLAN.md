---
phase: 10-polish
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - app/components/Desktop.tsx
  - app/components/DesktopIcon.tsx
  - app/contexts/WindowManagerContext.tsx
  - app/globals.css
autonomous: true

must_haves:
  truths:
    - "User can select desktop icons with click"
    - "User can multi-select with Ctrl+click"
    - "User can drag-select with mouse rectangle"
    - "Selected icons have blue highlight"
  artifacts:
    - path: "app/components/Desktop.tsx"
      provides: "Drag-select rectangle logic"
      min_lines: 200
    - path: "app/components/DesktopIcon.tsx"
      provides: "Selection state rendering"
      min_lines: 100
    - path: "app/contexts/WindowManagerContext.tsx"
      provides: "Selected icons state management"
      min_lines: 50
  key_links:
    - from: "app/components/DesktopIcon.tsx"
      to: "app/contexts/WindowManagerContext.tsx"
      via: "selectIcon function"
      pattern: "selectIcon|selectedIcons"
    - from: "app/components/Desktop.tsx"
      to: "app/components/DesktopIcon.tsx"
      via: "Intersection detection"
      pattern: "isIconInRectangle"
---

<objective>
Implement desktop icon selection, multi-select, and drag-select rectangle.

Purpose: Enable Windows 98 desktop icon interaction patterns
Output: Working icon selection system with visual feedback
</objective>

<execution_context>
@/Users/lucas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/lucas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-polish/10-CONTEXT.md
@.planning/phases/10-polish/10-RESEARCH.md
@app/components/Desktop.tsx
@app/components/DesktopIcon.tsx
@app/contexts/WindowManagerContext.tsx
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Add selected icon state to WindowManagerContext</name>
  <files>app/contexts/WindowManagerContext.tsx</files>
  <action>
Extend WindowManagerContext with icon selection state management:

1. **Add state**:
```typescript
const [selectedIcons, setSelectedIcons] = useState<string[]>([]);
```

2. **Add selection functions**:
```typescript
const selectIcon = useCallback((id: string, multiSelect: boolean = false) => {
  if (multiSelect) {
    setSelectedIcons(prev => 
      prev.includes(id) 
        ? prev.filter(i => i !== id) 
        : [...prev, id]
    );
  } else {
    setSelectedIcons([id]);
  }
}, []);

const selectMultipleIcons = useCallback((ids: string[]) => {
  setSelectedIcons(ids);
}, []);

const clearSelection = useCallback(() => {
  setSelectedIcons([]);
}, []);
```

3. **Add to context value**:
```typescript
value={{
  // ... existing values
  selectedIcons,
  selectIcon,
  selectMultipleIcons,
  clearSelection,
}}
```

4. **Update context type**:
```typescript
interface WindowManagerContextType {
  // ... existing properties
  selectedIcons: string[];
  selectIcon: (id: string, multiSelect?: boolean) => void;
  selectMultipleIcons: (ids: string[]) => void;
  clearSelection: () => void;
}
```
  </action>
  <verify>
1. Run: `npx tsc --noEmit`
2. Check that WindowManagerContext.tsx compiles with no type errors
3. Verify all new functions are included in context value
  </verify>
  <done>
WindowManagerContext has selectedIcons state and selection management functions (selectIcon, selectMultipleIcons, clearSelection). TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Add selection visual feedback to DesktopIcon</name>
  <files>
app/components/DesktopIcon.tsx
app/globals.css
  </files>
  <action>
Update DesktopIcon component to show selection state and handle click events:

**In DesktopIcon.tsx:**

1. **Get selection context**:
```typescript
const { selectedIcons, selectIcon } = useWindowManager();
const isSelected = selectedIcons.includes(icon.id);
```

2. **Update click handler** to support selection:
```typescript
const handleClick = (e: React.MouseEvent) => {
  e.stopPropagation();
  
  if (e.ctrlKey || e.metaKey) {
    // Multi-select (toggle)
    selectIcon(icon.id, true);
  } else if (e.detail === 1) {
    // Single click - select
    selectIcon(icon.id, false);
  }
  // Double-click still opens (existing behavior)
};
```

3. **Apply selection class**:
```typescript
<div 
  className={`desktop-icon ${isSelected ? 'selected' : ''}`}
  onClick={handleClick}
>
  {/* ... existing icon content */}
</div>
```

**In globals.css:**

4. **Add selection styles** (in Desktop Icon Styles section):
```css
.desktop-icon.selected {
  background: rgba(0, 0, 128, 0.3); /* Blue highlight */
  outline: 1px dotted #000;
}

.desktop-icon.selected .icon-label {
  background: var(--title-bar-active-start); /* Navy */
  color: var(--text-inverse); /* White */
}
```

5. **Ensure selection style** respects current theme (using CSS variables).
  </action>
  <verify>
1. Run: `npm run dev`
2. Open http://localhost:3000
3. Test icon selection:
   - **Click an icon**: Should highlight with blue background
   - **Click another icon**: First deselects, new one selects
   - **Ctrl+Click icon**: Should toggle selection (multi-select)
   - **Ctrl+Click multiple icons**: All should show selection
   - **Click desktop empty area**: All selections should clear
4. Verify selection visual matches Windows 98 style
  </verify>
  <done>
DesktopIcon component shows selection state with blue highlight. Click selects, Ctrl+click toggles. Icon label has navy background when selected. Selection styling respects theme colors.
  </done>
</task>

<task type="auto">
  <name>Implement drag-select rectangle in Desktop</name>
  <files>app/components/Desktop.tsx</files>
  <action>
Add drag-select functionality to Desktop component:

1. **Add drag-select state**:
```typescript
const [isDragSelecting, setIsDragSelecting] = useState(false);
const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
const [dragCurrent, setDragCurrent] = useState({ x: 0, y: 0 });
```

2. **Add mouse handlers**:
```typescript
const handleMouseDown = (e: React.MouseEvent) => {
  // Only start drag-select if clicking desktop itself (not icon)
  if (e.target === e.currentTarget && e.button === 0) {
    setIsDragSelecting(true);
    setDragStart({ x: e.clientX, y: e.clientY });
    setDragCurrent({ x: e.clientX, y: e.clientY });
    
    // Clear existing selection if not holding Ctrl
    if (!e.ctrlKey && !e.metaKey) {
      clearSelection();
    }
  }
};

const handleMouseMove = (e: MouseEvent) => {
  if (isDragSelecting) {
    setDragCurrent({ x: e.clientX, y: e.clientY });
    updateSelectionInRectangle();
  }
};

const handleMouseUp = () => {
  setIsDragSelecting(false);
};

useEffect(() => {
  if (isDragSelecting) {
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
    };
  }
}, [isDragSelecting]);
```

3. **Implement intersection detection**:
```typescript
const updateSelectionInRectangle = () => {
  const rect = {
    left: Math.min(dragStart.x, dragCurrent.x),
    top: Math.min(dragStart.y, dragCurrent.y),
    right: Math.max(dragStart.x, dragCurrent.x),
    bottom: Math.max(dragStart.y, dragCurrent.y),
  };
  
  const iconsInRect = icons.filter(icon => {
    const iconEl = document.getElementById(`desktop-icon-${icon.id}`);
    if (!iconEl) return false;
    
    const iconBounds = iconEl.getBoundingClientRect();
    return !(
      iconBounds.right < rect.left ||
      iconBounds.left > rect.right ||
      iconBounds.bottom < rect.top ||
      iconBounds.top > rect.bottom
    );
  });
  
  selectMultipleIcons(iconsInRect.map(i => i.id));
};
```

4. **Render selection rectangle**:
```tsx
{isDragSelecting && (
  <div
    className="selection-rectangle"
    style={{
      position: 'fixed',
      left: Math.min(dragStart.x, dragCurrent.x),
      top: Math.min(dragStart.y, dragCurrent.y),
      width: Math.abs(dragCurrent.x - dragStart.x),
      height: Math.abs(dragCurrent.y - dragStart.y),
      border: '1px solid var(--title-bar-active-start)',
      background: 'rgba(0, 0, 128, 0.1)',
      pointerEvents: 'none',
      zIndex: 9999,
    }}
  />
)}
```

5. **Update desktop div** to handle mouse down:
```tsx
<div 
  className="desktop"
  onMouseDown={handleMouseDown}
  onClick={clearSelection} // Clear on empty click
>
```

6. **Ensure DesktopIcon has id** for intersection detection:
```tsx
<div id={`desktop-icon-${icon.id}`} className="desktop-icon">
```
  </action>
  <verify>
1. Run: `npm run dev`
2. Open http://localhost:3000
3. Test drag-select:
   - **Click and drag on empty desktop**: Blue rectangle should appear
   - **Icons in rectangle**: Should be selected (highlighted)
   - **Release mouse**: Rectangle disappears, icons stay selected
   - **Ctrl+drag**: Should add to existing selection (not replace)
   - **Drag without Ctrl**: Should clear previous selection
4. Test edge cases:
   - Drag rectangle across multiple icons
   - Drag small rectangle (1px) - should not crash
   - Drag from bottom-right to top-left (negative drag)
  </verify>
  <done>
Desktop component implements drag-select with visual rectangle. Icons intersecting rectangle are selected. Rectangle has blue border and translucent fill. Ctrl-drag adds to selection. Works in all drag directions.
  </done>
</task>

</tasks>

<verification>
- [ ] WindowManagerContext has icon selection state management
- [ ] DesktopIcon shows selection with blue highlight
- [ ] Click icon selects it (clears others)
- [ ] Ctrl+Click toggles selection (multi-select)
- [ ] Drag-select rectangle appears on desktop drag
- [ ] Icons in rectangle are selected
- [ ] Ctrl+drag adds to existing selection
- [ ] Click empty desktop clears selection
- [ ] Selection styling respects theme colors
- [ ] No console errors or TypeScript errors
</verification>

<success_criteria>
- Single icon selection works (click)
- Multi-select works (Ctrl+click)
- Drag-select rectangle works (click-drag on desktop)
- Selected icons have blue highlight with navy label background
- Clicking empty desktop clears all selections
- Selection respects theme colors (uses CSS variables)
- Smooth interaction with no lag or jank
- All edge cases handled (negative drags, small rectangles, etc.)
- TypeScript strict mode passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-polish/10-06-SUMMARY.md`
</output>
